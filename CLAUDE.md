# OpenVault Development Guide

## Project Context (WHY)
OpenVault is a Retrieval-Augmented Generation (RAG) memory extension for SillyTavern. It provides POV-aware memory, relationship tracking, and emotional continuity by extracting events from chat history, embedding them locally, and injecting relevant context into prompts

## Tech Stack (WHAT)
- **Runtime**: Browser-based JavaScript (ES Modules). No bundler used for JS
- **UI**: jQuery (SillyTavern standard) + FontAwesome
- **Styles**: CSS variables, bundled via script
- **Testing**: Vitest with jsdom

## Architecture Map
- **`src/deps.js`**: **CRITICAL**. The sole bridge to SillyTavern/Browser globals (`getContext`, `extension_settings`, `fetch`). Enables testing
- **`src/retrieval/`**: RAG logic. `worker.js` handles heavy math off-thread
- **`src/extraction/`**: Logic for parsing chat messages into structured memory events
- **`src/embeddings/`**: Strategy pattern for vector providers (Transformers.js, Ollama)
- **`src/ui/`**: jQuery-based UI logic
- **`src/state.js`**: Manages async locks to prevent concurrent operations

## Workflows (HOW)

### 1. CSS Changes
**Never edit `style.css` directly.** It is autogenerated
1. Modify files in `src/styles/` (e.g., `src/styles/components/cards.css`)
2. Run build: `npm run build:css`

### 2. Testing & Verification
- **Run Tests**: `npm test` (Runs Vitest, CSS build, and version sync)
- **Linting**: `npm run lint`
- **Manual Check**: Since this is an extension, final verification requires loading into SillyTavern. Check browser console for `[OpenVault]` logs

### 3. Coding Guidelines
1.  **Strict Dependency Injection**: NEVER access globals like `SillyTavern.getContext`, `window`, or `fetch` directly in source files
    -   *Wrong*: `SillyTavern.getContext()`
    -   *Right*: `import { getDeps } from './deps.js'; getDeps().getContext()`
2.  **Async Safety**: Always check `src/state.js` locks (`generationInProgress`) before triggering background LLM tasks
3.  **Data Persistence**: Store data in `context.chatMetadata['openvault']`. Use `saveOpenVaultData()` wrapper from `src/utils.js`
4.  **Worker Logic**: `src/retrieval/worker.js` must remain self-contained or use native ESM imports (`type: module`)

## Auto-Worktree Behavior

Rule: Claude must create a worktree before modifying any file.

Conversation starts → No worktree (exploration, questions, reading code)
                   ↓
About to modify file(s) → Check: Already in worktree?
                   ↓
              ┌────┴────┐
              │         │
             YES        NO
              │         │
              ↓         ↓
          Proceed    Invoke `superpowers:using-git-worktrees`
          with       Create worktree → Copy env files → Then modify
          edits

To remove worktree use `git worktree remove .worktrees/XYZ && git branch -d feature/XYZ`
