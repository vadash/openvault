<div id="openvault_settings">
    <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
            <b>OpenVault</b>
            <span id="openvault_status" class="openvault-status ready">Ready</span>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content">
            <!-- Tab Navigation -->
            <div class="openvault-tab-nav">
                <button class="openvault-tab-btn active" data-tab="dashboard">
                    <i class="fa-solid fa-gauge-high"></i> Dashboard
                </button>
                <button class="openvault-tab-btn" data-tab="memory-bank">
                    <i class="fa-solid fa-brain"></i> Memory Bank
                </button>
                <button class="openvault-tab-btn" data-tab="configuration">
                    <i class="fa-solid fa-sliders"></i> Config
                </button>
                <button class="openvault-tab-btn" data-tab="system">
                    <i class="fa-solid fa-gear"></i> System
                </button>
            </div>

            <!-- ================================================================
                 TAB 1: DASHBOARD
                 ================================================================ -->
            <div class="openvault-tab-content active" data-tab="dashboard">
                <!-- Status Card -->
                <div class="openvault-card openvault-status-card">
                    <div class="openvault-status-indicator ready" id="openvault_status_indicator">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <div class="openvault-status-info">
                        <div class="openvault-status-text" id="openvault_status_text">Ready</div>
                        <div class="openvault-status-subtext" id="openvault_status_subtext">OpenVault is idle</div>
                        <div id="openvault_dashboard_embedding_status" class="openvault-embedding-status loading">
                            <i class="fa-solid fa-circle-notch fa-spin"></i>
                            <span>Embeddings not loaded</span>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="openvault-stats-grid">
                    <div class="openvault-stat-card">
                        <div class="stat-icon"><i class="fa-solid fa-database"></i></div>
                        <div class="stat-value" id="openvault_stat_events">0</div>
                        <div class="stat-label">Memories</div>
                    </div>
                    <div class="openvault-stat-card">
                        <div class="stat-icon"><i class="fa-solid fa-users"></i></div>
                        <div class="stat-value" id="openvault_stat_characters">0</div>
                        <div class="stat-label">Characters</div>
                    </div>
                    <div class="openvault-stat-card">
                        <div class="stat-icon"><i class="fa-solid fa-vector-square"></i></div>
                        <div class="stat-value" id="openvault_stat_embeddings">0</div>
                        <div class="stat-label">Embeddings</div>
                    </div>
                </div>

                <!-- Batch Progress -->
                <div class="openvault-card">
                    <div class="openvault-card-header">
                        <span class="openvault-card-title"><i class="fa-solid fa-bars-progress"></i> Extraction Progress</span>
                    </div>
                    <div class="openvault-batch-progress">
                        <div class="openvault-batch-progress-bar">
                            <div class="openvault-batch-progress-fill" id="openvault_batch_progress_fill"></div>
                        </div>
                        <span class="openvault-batch-progress-label" id="openvault_batch_progress_label">No chat</span>
                    </div>
                    <div class="openvault-button-row">
                        <button id="openvault_extract_all_btn" class="menu_button">
                            <i class="fa-solid fa-layer-group"></i> Backfill History
                        </button>
                        <button id="openvault_backfill_embeddings_btn" class="menu_button">
                            <i class="fa-solid fa-vector-square"></i> Generate Embeddings
                        </button>
                    </div>
                </div>

                <!-- Quick Toggles -->
                <div class="openvault-card">
                    <div class="openvault-card-header">
                        <span class="openvault-card-title"><i class="fa-solid fa-toggle-on"></i> Quick Toggles</span>
                    </div>
                    <div class="openvault-quick-toggles">
                        <label class="openvault-quick-toggle">
                            <input type="checkbox" id="openvault_enabled" checked />
                            <span>Enable OpenVault</span>
                        </label>
                        <label class="openvault-quick-toggle">
                            <input type="checkbox" id="openvault_auto_hide" checked />
                            <span>Auto-hide Messages</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- ================================================================
                 TAB 2: MEMORY BANK
                 ================================================================ -->
            <div class="openvault-tab-content" data-tab="memory-bank">
                <!-- Search -->
                <div class="openvault-search-container">
                    <i class="fa-solid fa-search"></i>
                    <input type="text" id="openvault_memory_search" class="openvault-search-input" placeholder="Search memories..." />
                </div>

                <!-- Filters -->
                <div class="openvault-filters">
                    <select id="openvault_filter_type" class="text_pole">
                        <option value="">All Types</option>
                        <option value="action">Actions</option>
                        <option value="revelation">Revelations</option>
                        <option value="emotion_shift">Emotion Shifts</option>
                        <option value="relationship_change">Relationship Changes</option>
                    </select>
                    <select id="openvault_filter_character" class="text_pole">
                        <option value="">All Characters</option>
                    </select>
                </div>

                <!-- Memory List -->
                <div id="openvault_memory_list" class="openvault-memory-list">
                    <p class="openvault-placeholder">No memories yet</p>
                </div>

                <!-- Pagination -->
                <div class="openvault-pagination">
                    <button id="openvault_prev_page" class="menu_button" disabled>
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <span id="openvault_page_info">Page 1</span>
                    <button id="openvault_next_page" class="menu_button" disabled>
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>

                <!-- Character States (collapsed) -->
                <div class="inline-drawer" style="margin-top: 15px;">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <span>Character States</span>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <div id="openvault_character_states" class="openvault-character-list">
                            <p class="openvault-placeholder">No character data yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================================================================
                 TAB 3: CONFIGURATION
                 ================================================================ -->
            <div class="openvault-tab-content" data-tab="configuration">
                <!-- LLM Strategy Group -->
                <div class="openvault-settings-group">
                    <div class="openvault-settings-group-header">
                        <i class="fa-solid fa-brain"></i>
                        <span>LLM Strategy</span>
                    </div>

                    <label for="openvault_extraction_profile">Extraction Profile</label>
                    <select id="openvault_extraction_profile" class="text_pole">
                        <option value="">Use current connection</option>
                    </select>
                    <small class="openvault-hint">LLM profile for memory extraction</small>

                    <label class="checkbox_label" style="margin-top: 10px;">
                        <input type="checkbox" id="openvault_smart_retrieval" checked />
                        <span>Smart Retrieval (LLM-assisted)</span>
                    </label>
                    <small class="openvault-hint">Use LLM to select most relevant memories</small>

                    <div id="openvault_retrieval_profile_group" style="margin-top: 8px;">
                        <label for="openvault_retrieval_profile">Retrieval Profile</label>
                        <select id="openvault_retrieval_profile" class="text_pole">
                            <option value="">Use current connection</option>
                        </select>
                        <small class="openvault-hint">Can use a faster/cheaper model</small>
                    </div>
                </div>

                <!-- Embedding Settings Group -->
                <div class="openvault-settings-group">
                    <div class="openvault-settings-group-header">
                        <i class="fa-solid fa-vector-square"></i>
                        <span>Embeddings</span>
                    </div>

                    <label for="openvault_embedding_source">Embedding Model</label>
                    <select id="openvault_embedding_source" class="text_pole">
                        <optgroup label="Multilingual">
                            <option value="multilingual-e5-small">multilingual-e5-small - 384d · 118M · 100+ langs · MTEB: 55.8</option>
                            <option value="embeddinggemma-300m">embeddinggemma-300m - 768d · 300M · 100+ langs · MTEB: 61.2 (WebGPU)</option>
                        </optgroup>
                        <optgroup label="English Only">
                            <option value="bge-small-en-v1.5">bge-small-en-v1.5 - 384d · 133MB · MTEB: 62.17 · SOTA RAG</option>
                        </optgroup>
                        <optgroup label="External">
                            <option value="ollama">Ollama (Custom server)</option>
                        </optgroup>
                    </select>


                    <!-- Embedding Prefixes -->
                    <label for="openvault_embedding_query_prefix">Query Prefix</label>
                    <input id="openvault_embedding_query_prefix" type="text" class="text_pole" placeholder="search for similar scenes: " />
                    <small class="openvault-hint">Prepended to search queries. For asymmetric models (e.g. EmbeddingGemma).</small>

                    <label for="openvault_embedding_doc_prefix">Document Prefix</label>
                    <input id="openvault_embedding_doc_prefix" type="text" class="text_pole" placeholder="" />
                    <small class="openvault-hint">Prepended to documents before embedding. Leave empty if tags handle it.</small>

                    <!-- Embedding Status -->
                    <div id="openvault_embedding_status_container">
                        <div id="openvault_embedding_status" class="openvault-embedding-status loading">
                            <i class="fa-solid fa-circle-notch fa-spin"></i>
                            <span>Not loaded</span>
                        </div>
                    </div>

                    <!-- Ollama Settings (hidden by default) -->
                    <div id="openvault_ollama_settings" style="display: none; margin-top: 10px;">
                        <label for="openvault_ollama_url">
                            Ollama URL
                            <button id="openvault_test_ollama_btn" class="menu_button openvault-test-btn">
                                <i class="fa-solid fa-plug"></i> Test
                            </button>
                        </label>
                        <input type="text" id="openvault_ollama_url" class="text_pole" placeholder="http://localhost:11434" />
                        <small class="openvault-hint"><strong>CORS required:</strong> Set <code>OLLAMA_ORIGINS=*</code></small>

                        <label for="openvault_embedding_model">Model Name</label>
                        <input type="text" id="openvault_embedding_model" class="text_pole" placeholder="nomic-embed-text" />
                    </div>

                    <!-- WebGPU Help -->
                    <details class="openvault-details">
                        <summary><i class="fa-solid fa-bolt"></i> Enable WebGPU (optional)</summary>
                        <div class="openvault-help-content">
                            <p>WebGPU requires <strong>secure context</strong> (HTTPS or localhost). For HTTP:</p>
                            <ol>
                                <li>Go to <code>chrome://flags</code></li>
                                <li>Enable <code>#enable-unsafe-webgpu</code></li>
                                <li>Enable <code>#enable-webgpu-developer-features</code></li>
                                <li>In <code>#unsafely-treat-insecure-origin-as-secure</code> add your SillyTavern URL</li>
                                <li>Restart browser</li>
                            </ol>
                        </div>
                    </details>
                </div>

                <!-- Pipeline Tuning Group -->
                <div class="openvault-settings-group">
                    <div class="openvault-settings-group-header">
                        <i class="fa-solid fa-gears"></i>
                        <span>Pipeline Tuning</span>
                    </div>

                    <label for="openvault_messages_per_extraction">
                        Messages per Extraction: <span id="openvault_messages_per_extraction_value">10</span>
                        <small class="openvault-default-hint" data-default-key="messagesPerExtraction"></small>
                    </label>
                    <input type="range" id="openvault_messages_per_extraction" min="10" max="50" step="5" value="10" />

                    <div style="height: 8px;"></div>

                    <label for="openvault_final_budget">
                        Final Context Budget: <span id="openvault_final_budget_value">12000</span> tokens
                        <small class="openvault-default-hint" data-default-key="retrievalFinalTokens"></small>
                        <small class="openvault-words-hint">~<span id="openvault_final_budget_words">9000</span> words</small>
                    </label>
                    <input type="range" id="openvault_final_budget" min="1000" max="32000" step="1000" value="12000" />
                    <small class="openvault-hint">Memory budget injected into chat context</small>

                    <div style="height: 8px;"></div>

                    <label for="openvault_auto_hide_threshold">
                        Messages to keep visible: <span id="openvault_auto_hide_threshold_value">50</span>
                        <small class="openvault-default-hint" data-default-key="autoHideThreshold"></small>
                    </label>
                    <input type="range" id="openvault_auto_hide_threshold" min="10" max="200" step="2" value="50" />

                    <!-- Advanced Parameters (collapsed) -->
                    <details class="openvault-advanced-toggle">
                        <summary><i class="fa-solid fa-sliders"></i> Advanced Parameters</summary>
                        <div class="openvault-advanced-content">
                            <!-- Scoring & Weights -->
                            <div style="margin-bottom: 15px;">
                                <div style="font-weight: bold; margin-bottom: 10px; color: var(--SmartThemeQuoteColor);">
                                    <i class="fa-solid fa-scale-balanced"></i> Scoring & Weights
                                </div>
                                <small style="display: block; margin-bottom: 10px; color: var(--SmartThemeQuoteColor);">
                                    Balance how memories are ranked during retrieval. Higher values = more influence.
                                </small>

                                <label for="openvault_alpha">
                                    Vector vs Keyword Balance: <span id="openvault_alpha_value">0.7</span>
                                    <small class="openvault-default-hint" data-default-key="alpha"></small>
                                </label>
                                <input type="range" id="openvault_alpha" min="0" max="1" step="0.05" value="0.7" />
                                <small class="openvault-hint">1.0 = semantic vibes only · 0.5 = balanced · 0.0 = keywords only</small>

                                <div style="height: 8px;"></div>

                                <label for="openvault_combined_weight" style="margin-top: 10px;">
                                    Retrieval Boost Strength: <span id="openvault_combined_weight_value">15</span>
                                    <small class="openvault-default-hint" data-default-key="combinedBoostWeight"></small>
                                </label>
                                <input type="range" id="openvault_combined_weight" min="1" max="30" step="1" value="15" />
                                <small class="openvault-hint">Maximum boost points for semantic+keyword matching</small>

                                <div style="height: 8px;"></div>

                                <label for="openvault_vector_threshold" style="margin-top: 10px;">
                                    Semantic Threshold: <span id="openvault_vector_threshold_value">0.5</span>
                                    <small class="openvault-default-hint" data-default-key="vectorSimilarityThreshold"></small>
                                </label>
                                <input type="range" id="openvault_vector_threshold" min="0" max="1" step="0.05" value="0.5" />
                                <small class="openvault-hint">Noise filter. 0.7+ = strict (only close matches), 0.3- = loose</small>

                                <div style="height: 8px;"></div>

                                <label for="openvault_dedup_threshold" style="margin-top: 10px;">
                                    Dedup Similarity Threshold: <span id="openvault_dedup_threshold_value">0.85</span>
                                    <small class="openvault-default-hint" data-default-key="dedupSimilarityThreshold"></small>
                                </label>
                                <input type="range" id="openvault_dedup_threshold" min="0.70" max="0.95" step="0.01" value="0.85" />
                                <small class="openvault-hint">0.80 = aggressive (fewer dupes) · 0.85 = default · 0.90 = conservative (more memories)</small>
                            </div>

                            <hr style="margin: 15px 0; border: none; border-top: 1px solid var(--SmartThemeShadowColor);">

                            <!-- Query Context Enhancement -->
                            <div style="margin-bottom: 15px;">
                                <div style="font-weight: bold; margin-bottom: 10px; color: var(--SmartThemeQuoteColor);">
                                    <i class="fa-solid fa-magnifying-glass-chart"></i> Query Enhancement
                                </div>
                                <small style="display: block; margin-bottom: 10px; color: var(--SmartThemeQuoteColor);">
                                    Extracts names and themes from recent chat to improve retrieval accuracy.
                                </small>

                                <label for="openvault_entity_window">
                                    Entity Window: <span id="openvault_entity_window_value">10</span> messages
                                    <small class="openvault-default-hint" data-default-key="entityWindowSize"></small>
                                </label>
                                <input type="range" id="openvault_entity_window" min="3" max="20" step="1" value="10" />
                                <small class="openvault-hint">Messages to scan for names/places</small>

                                <div style="height: 8px;"></div>

                                <label for="openvault_embedding_window">
                                    Embedding Window: <span id="openvault_embedding_window_value">5</span> messages
                                    <small class="openvault-default-hint" data-default-key="embeddingWindowSize"></small>
                                </label>
                                <input type="range" id="openvault_embedding_window" min="2" max="10" step="1" value="5" />
                                <small class="openvault-hint">Messages to include in semantic query</small>

                                <div style="height: 8px;"></div>

                                <label for="openvault_top_entities">
                                    Top Entities: <span id="openvault_top_entities_value">5</span>
                                    <small class="openvault-default-hint" data-default-key="topEntitiesCount"></small>
                                </label>
                                <input type="range" id="openvault_top_entities" min="1" max="10" step="1" value="5" />
                                <small class="openvault-hint">Max entities to inject into query</small>

                                <div style="height: 8px;"></div>

                                <label for="openvault_entity_boost">
                                    Entity Boost: <span id="openvault_entity_boost_value">5.0</span>x
                                    <small class="openvault-default-hint" data-default-key="entityBoostWeight"></small>
                                </label>
                                <input type="range" id="openvault_entity_boost" min="0.5" max="15" step="0.5" value="5.0" />
                                <small class="openvault-hint">BM25 weight multiplier for entities</small>
                            </div>

                            <hr style="margin: 15px 0; border: none; border-top: 1px solid var(--SmartThemeShadowColor);">
                            <label for="openvault_extraction_rearview">
                                Context Window Size: <span id="openvault_extraction_rearview_value">12000</span> tokens
                                <small class="openvault-default-hint" data-default-key="contextWindowSize"></small>
                                <small class="openvault-words-hint">~<span id="openvault_extraction_rearview_words">9000</span> words</small>
                            </label>
                            <input type="range" id="openvault_extraction_rearview" min="1000" max="32000" step="1000" value="12000" />
                            <small class="openvault-hint">How much past memories the LLM sees when writing new memories</small>

                            <div style="height: 8px;"></div>

                            <label for="openvault_prefilter_budget" style="margin-top: 10px;">
                                Pre-filter Budget: <span id="openvault_prefilter_budget_value">24000</span> tokens
                                <small class="openvault-default-hint" data-default-key="retrievalPreFilterTokens"></small>
                                <small class="openvault-words-hint">~<span id="openvault_prefilter_budget_words">18000</span> words</small>
                            </label>
                            <input type="range" id="openvault_prefilter_budget" min="1000" max="32000" step="1000" value="24000" />
                            <small class="openvault-hint">Algorithmic filter (recency + vector similarity)</small>

                            <div style="height: 8px;"></div>

                            <label for="openvault_backfill_rpm" style="margin-top: 10px;">
                                Backfill Rate Limit (RPM)
                                <small class="openvault-default-hint" data-default-key="backfillRateLimit"></small>
                            </label>
                            <input type="number" id="openvault_backfill_rpm" class="text_pole" min="1" max="600" value="30" />
                        </div>
                    </details>
                </div>
            </div>

            <!-- ================================================================
                 TAB 4: SYSTEM
                 ================================================================ -->
            <div class="openvault-tab-content" data-tab="system">
                <!-- Debug Settings -->
                <div class="openvault-card">
                    <div class="openvault-card-header">
                        <span class="openvault-card-title"><i class="fa-solid fa-bug"></i> Debug</span>
                    </div>
                    <label class="checkbox_label">
                        <input type="checkbox" id="openvault_debug" />
                        <span>Debug Mode</span>
                    </label>
                    <small class="openvault-hint">Enable verbose logging to console</small>
                    <button id="openvault_copy_weights_btn" class="menu_button" style="margin-top: 10px;">
                        <i class="fa-solid fa-copy"></i> Copy Memory Weights
                    </button>
                </div>

                <!-- Danger Zone -->
                <div class="openvault-card openvault-danger">
                    <div class="openvault-card-header">
                        <span class="openvault-card-title" style="color: var(--error-color, #c44);">
                            <i class="fa-solid fa-triangle-exclamation"></i> Danger Zone
                        </span>
                    </div>
                    <p style="font-size: 0.85em; color: var(--SmartThemeEmColor, #888); margin-bottom: 10px;">
                        These actions cannot be undone.
                    </p>
                    <button id="openvault_delete_chat_btn" class="menu_button danger wide">
                        <i class="fa-solid fa-trash"></i> Delete Current Chat Memories
                    </button>
                    <button id="openvault_delete_embeddings_btn" class="menu_button danger wide" style="margin-top: 8px;">
                        <i class="fa-solid fa-eraser"></i> Delete Current Chat Embeddings
                    </button>
                </div>

                <!-- Footer -->
                <div class="openvault-footer">
                    <small>OpenVault v<span id="openvault_version"></span> - Free & Open Source Agentic Memory</small>
                </div>
            </div>

            <!-- Hidden legacy elements for backward compatibility -->
            <span id="openvault_stat_events_badge" style="display: none;">0 events</span>
            <span id="openvault_stat_embeddings_badge" style="display: none;">0 embeddings</span>
            <span id="openvault_stat_characters_badge" style="display: none;">0 chars</span>
        </div>
    </div>
</div>
