<div id="openvault_settings">
    <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
            <b>OpenVault</b>
            <span id="openvault_status" class="openvault-status ready">Ready</span>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content">
            <!-- Section 1: General -->
            <div class="openvault-section">
                <label class="checkbox_label">
                    <input type="checkbox" id="openvault_enabled" checked />
                    <span>Enable OpenVault</span>
                </label>
            </div>

            <!-- Section 2: Extraction (The Rearview) -->
            <div class="openvault-section">
                <h4>Extraction</h4>

                <label for="openvault_extraction_profile">Extraction Profile</label>
                <select id="openvault_extraction_profile" class="text_pole">
                    <option value="">Use current connection</option>
                </select>
                <small class="openvault-hint">LLM profile for memory extraction</small>

                <label for="openvault_messages_per_extraction">
                    Messages per Extraction: <span id="openvault_messages_per_extraction_value">10</span>
                </label>
                <input type="range" id="openvault_messages_per_extraction" min="10" max="50" step="5" value="10" />

                <label for="openvault_extraction_rearview">
                    Extraction Rearview: <span id="openvault_extraction_rearview_value">12000</span> tokens
                    <small class="openvault-words-hint">~<span id="openvault_extraction_rearview_words">9000</span> words</small>
                </label>
                <input type="range" id="openvault_extraction_rearview" min="1000" max="32000" step="1000" value="12000" />
                <small class="openvault-hint">How much past memories the LLM sees when writing new memories</small>
            </div>

            <!-- Section 3: Retrieval Pipeline -->
            <div class="openvault-section">
                <h4>Retrieval Pipeline</h4>

                <label for="openvault_prefilter_budget">
                    Stage 1 - Pre-filter Budget: <span id="openvault_prefilter_budget_value">24000</span> tokens
                    <small class="openvault-words-hint">~<span id="openvault_prefilter_budget_words">18000</span> words</small>
                </label>
                <input type="range" id="openvault_prefilter_budget" min="1000" max="32000" step="1000" value="24000" />
                <small class="openvault-hint">Algorithmic filter (recency + vector similarity)</small>

                <label class="checkbox_label">
                    <input type="checkbox" id="openvault_smart_retrieval" checked />
                    <span>Stage 2 - Smart Retrieval</span>
                </label>
                <small class="openvault-hint">Use LLM to select most relevant memories</small>

                <div id="openvault_retrieval_profile_group">
                    <label for="openvault_retrieval_profile">Retrieval Profile</label>
                    <select id="openvault_retrieval_profile" class="text_pole">
                        <option value="">Use current connection</option>
                    </select>
                    <small class="openvault-hint">LLM profile for smart retrieval (can use faster model)</small>
                </div>

                <label for="openvault_final_budget">
                    Stage 3 - Final Context Budget: <span id="openvault_final_budget_value">12000</span> tokens
                    <small class="openvault-words-hint">~<span id="openvault_final_budget_words">9000</span> words</small>
                </label>
                <input type="range" id="openvault_final_budget" min="1000" max="32000" step="1000" value="12000" />
                <small class="openvault-hint">Injected into chat context</small>
            </div>

            <!-- Section 4: Vector & Storage -->
            <div class="openvault-section">
                <h4>Vector & Storage</h4>

                <label for="openvault_embedding_source">Embedding Model</label>
                <select id="openvault_embedding_source" class="text_pole">
                    <optgroup label="Multilingual">
                        <option value="multilingual-e5-small">multilingual-e5-small - Best quality (100+ langs)</option>
                        <option value="paraphrase-multilingual-MiniLM-L12-v2">paraphrase-MiniLM - Cross-lingual similarity (50+ langs)</option>
                    </optgroup>
                    <optgroup label="English Only">
                        <option value="all-MiniLM-L6-v2">all-MiniLM-L6-v2 - Fastest load (~25MB)</option>
                        <option value="bge-small-en-v1.5">bge-small-en-v1.5 - Best RAG retrieval</option>
                    </optgroup>
                    <optgroup label="External">
                        <option value="ollama">Ollama (Custom server)</option>
                    </optgroup>
                </select>
                <small class="openvault-hint">Auto-detects WebGPU for optimal performance, falls back to WASM</small>
                <div id="openvault_embedding_status" class="openvault-badge" style="margin-top: 5px;">Not loaded</div>

                <div id="openvault_ollama_settings" style="display: none;">
                    <label for="openvault_ollama_url">Ollama URL</label>
                    <input type="text" id="openvault_ollama_url" class="text_pole" placeholder="http://localhost:11434" />
                    <small class="openvault-hint"><strong>CORS required:</strong> Windows: set <code>OLLAMA_ORIGINS=*</code> in environment variables. Linux/Mac: <code>OLLAMA_ORIGINS=* ollama serve</code></small>

                    <label for="openvault_embedding_model">Ollama Model Name</label>
                    <input type="text" id="openvault_embedding_model" class="text_pole" placeholder="nomic-embed-text" />
                </div>

                <label class="checkbox_label">
                    <input type="checkbox" id="openvault_auto_hide" checked />
                    <span>Auto-hide old messages</span>
                </label>

                <label for="openvault_auto_hide_threshold">
                    Messages to keep visible: <span id="openvault_auto_hide_threshold_value">50</span>
                </label>
                <input type="range" id="openvault_auto_hide_threshold" min="10" max="200" step="2" value="50" />

                <label for="openvault_backfill_rpm">Backfill Rate Limit (RPM)</label>
                <input type="number" id="openvault_backfill_rpm" class="text_pole" min="1" max="600" value="30" />

                <div class="openvault-button-row">
                    <button id="openvault_extract_all_btn" class="menu_button">
                        <i class="fa-solid fa-layer-group"></i> Backfill History
                    </button>
                    <button id="openvault_backfill_embeddings_btn" class="menu_button">
                        <i class="fa-solid fa-vector-square"></i> Generate Embeddings
                    </button>
                </div>
            </div>

            <!-- Section 5: Statistics -->
            <div class="openvault-section">
                <h4>Statistics</h4>
                <div class="openvault-stats-compact">
                    <span class="openvault-badge" id="openvault_stat_events_badge">0 events</span>
                    <span class="openvault-badge" id="openvault_stat_characters_badge">0 chars</span>
                    <span class="openvault-badge" id="openvault_stat_next_extraction_badge">-</span>
                </div>
                <div class="openvault-extraction-bar">
                    <div class="openvault-extraction-progress" id="openvault_extraction_progress"></div>
                    <span class="openvault-extraction-label" id="openvault_extraction_label">0 / 0 extracted</span>
                </div>
                <button id="openvault_refresh_stats_btn" class="menu_button">
                    <i class="fa-solid fa-refresh"></i> Refresh
                </button>
            </div>

            <!-- Memory Browser (collapsed by default) -->
            <div class="openvault-section">
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <span>Memory Browser</span>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <div class="openvault-filters">
                            <select id="openvault_filter_type" class="text_pole">
                                <option value="">All Types</option>
                                <option value="action">Actions</option>
                                <option value="revelation">Revelations</option>
                                <option value="emotion_shift">Emotion Shifts</option>
                                <option value="relationship_change">Relationship Changes</option>
                            </select>
                            <select id="openvault_filter_character" class="text_pole">
                                <option value="">All Characters</option>
                            </select>
                        </div>
                        <div id="openvault_memory_list" class="openvault-memory-list">
                            <p class="openvault-placeholder">No memories yet</p>
                        </div>
                        <div class="openvault-pagination">
                            <button id="openvault_prev_page" class="menu_button" disabled>
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            <span id="openvault_page_info">Page 1</span>
                            <button id="openvault_next_page" class="menu_button" disabled>
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Character States (collapsed by default) -->
            <div class="openvault-section">
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <span>Character States</span>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <div id="openvault_character_states" class="openvault-character-list">
                            <p class="openvault-placeholder">No character data yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relationships (collapsed by default) -->
            <div class="openvault-section">
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <span>Relationships</span>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <div id="openvault_relationships" class="openvault-relationship-list">
                            <p class="openvault-placeholder">No relationship data yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Debug -->
            <div class="openvault-section">
                <label class="checkbox_label">
                    <input type="checkbox" id="openvault_debug" />
                    <span>Debug Mode</span>
                </label>
            </div>

            <!-- Danger Zone -->
            <div class="openvault-section openvault-danger">
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <span>Danger Zone</span>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <button id="openvault_delete_chat_btn" class="menu_button danger">
                            <i class="fa-solid fa-trash"></i> Delete Current Chat Memories
                        </button>
                        <button id="openvault_delete_embeddings_btn" class="menu_button danger">
                            <i class="fa-solid fa-eraser"></i> Delete Current Chat Embeddings
                        </button>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="openvault-footer">
                <small>OpenVault v<span id="openvault_version"></span> - Free & Open Source Agentic Memory</small>
            </div>
        </div>
    </div>
</div>
